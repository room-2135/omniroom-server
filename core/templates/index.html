<!-- core/templates/index.html -->
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>Omniroom</title>
    </head>
    <body>
	    <video id="stream" autoplay playsinline>Your browser doesn"t support video</video>
        <script>
            var commandsMapping = {
                "JOINED_CLIENT": onJoined,
                "UPDATE_CAMERAS": onUpdateRequested,
                "SERVER_ERROR": onServerError,
                "MESSAGE": onMessage,
                "SDP_OFFER": onSDPOffer,
                "ICE_CANDIDATE": onICECandidate,
            }

            var uuid;

            var connections = [];

            var socket;
            window.onload = function(){
                connect();
            }
            function connect() {
                socket = new WebSocket("ws://" + window.location.host);

                socket.onopen = function(e) {
                    console.log("WebSocket connection opened");
                    join();
                };

                socket.onclose = function(e) {
                    console.log("WebSocket connection closed");
                    setTimeout(connect, 2000);
                };

                socket.onmessage = function(e) {
                    var data = JSON.parse(e.data);
                    console.debug(data);
                    try {
                        commandsMapping[data.command](data);
                    } catch(err) {
                        onError(err, data);
                    }
                };
            }

            function onError(err, data) {
                console.error("Client error:");
                console.error(err);
            }

            function onServerError(data) {
                console.error("Server error:");
                console.error(data.error);
            }

            function join() {
                socket.send(JSON.stringify({
                    "command": "JOIN_CLIENT"
                }));
            }

            function onJoined(data) {
                identifier = data.identifier;
                console.log("JOINED: " + identifier);
            }

            function onUpdateRequested(data) {
                console.log("CAMERAS UPDATE REQUESTED");
                createCall();
                socket.send(JSON.stringify({"command": "CALL", "identifier": "test"}));
            }

            function onMessage(data) {
                console.log("MESSAGE");
                console.log(data["message"])
            }

            function onSDPOffer(data) {
                console.log("SDP OFFER from: " + data["identifier"]);
                console.debug("Offer: ")
                console.debug(data["offer"]);
                connections[data["identifier"]].setRemoteDescription(data["offer"]).then(() => {
                    if (data["offer"].type != "offer")
                        return;
                    connections[data["identifier"]].createAnswer().then((desc) => {
                        connections[data["identifier"]].setLocalDescription(desc).then(function() {
                            sdp = {
                                "command": "SDP_ANSWER",
                                "identifier": data["identifier"],
                                "offer": connections[data["identifier"]].localDescription
                            }
                            socket.send(JSON.stringify(sdp));
                        });
                    });
                });
            }

            function onICECandidate(data) {
                var candidate = new RTCIceCandidate(data['ice']);
                connections[data["identifier"]].addIceCandidate(candidate).catch(onError);
            }

            //===========================STREAM=================================
            // Override with your own STUN servers if you want
            var rtc_configuration = {iceServers: [{urls: "stun:stun.services.mozilla.com"},
                                                  {urls: "stun:stun.l.google.com:19302"}]};

            function createCall() {
                // Reset connection attempts because we connected successfully
                connect_attempts = 0;

                console.log("Creating RTCPeerConnection");

                var na = "test";

                connections[na] = new RTCPeerConnection(rtc_configuration);
                send_channel = connections[na].createDataChannel("label", null);
                send_channel.onopen = handleDataChannelOpen;
                send_channel.onmessage = handleDataChannelMessageReceived;
                send_channel.onerror = handleDataChannelError;
                send_channel.onclose = handleDataChannelClose;
                connections[na].ondatachannel = onDataChannel;
                connections[na].ontrack = onRemoteTrack;
                /* Send our video/audio to the other peer */

                connections[na].onicecandidate = (event) => {
                    // We have a candidate, send it to the remote party with the
                    // same uuid
                    if (event.candidate == null) {
                        console.log("ICE Candidate was null, done");
                        return;
                    }
                    socket.send(JSON.stringify({"command": "ICE_ANSWER", "identifier": "test", "ice": event.candidate}));
                };
            }

            function getVideoElement() {
                return document.getElementById("stream");
            }

            // Local description was set, send it to peer
            function onLocalDescription(desc) {
                console.log("Got local description: " + JSON.stringify(desc));
                connections[data["identifier"]].setLocalDescription(desc).then(function() {
                    setStatus("Sending SDP answer");
                    socket.send(JSON.stringify({"command": "CLIENT_MSG", "camera": "test", "sdp": connections[data["identifier"]].localDescription}));
                });
            }

            const handleDataChannelOpen = (event) =>{
                console.log("dataChannel.OnOpen", event);
            };

            const handleDataChannelMessageReceived = (event) =>{
                console.log("dataChannel.OnMessage:", event, event.data.type);

                setStatus("Received data channel message");
                if (typeof event.data === "string" || event.data instanceof String) {
                    console.log("Incoming string message: " + event.data);
                    var textarea = document.getElementById("text")
                    textarea.value = textarea.value + "\n" + event.data
                } else {
                    console.log("Incoming data message");
                }
                send_channel.send("Hi! (from browser)");
            };

            const handleDataChannelError = (error) =>{
                console.log("dataChannel.OnError:", error);
            };

            const handleDataChannelClose = (event) =>{
                console.log("dataChannel.OnClose", event);
            };

            function onDataChannel(event) {
                setStatus("Data channel created");
                let receiveChannel = event.channel;
                receiveChannel.onopen = handleDataChannelOpen;
                receiveChannel.onmessage = handleDataChannelMessageReceived;
                receiveChannel.onerror = handleDataChannelError;
                receiveChannel.onclose = handleDataChannelClose;
            }

            function onRemoteTrack(event) {
                if (getVideoElement().srcObject !== event.streams[0]) {
                    console.log("Incoming stream");
                    getVideoElement().srcObject = event.streams[0];
                }
            }
        </script>
    </body>
</html>
